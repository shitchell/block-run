#!/usr/bin/env python3
"""
Python wrapper for block-run.
Minimal: emits markers, executes blocks with exec() in shared globals.
Dispatcher handles headers, highlighting, separators.
"""
import sys
import traceback

# Marker character (ASCII Group Separator)
MARKER = '\x1d'

# Colors for exit code display
RED = '\033[31m'
RESET = '\033[0m'

def main():
    # Parse args - skip everything before '--'
    args = sys.argv[1:]
    if '--' in args:
        args = args[args.index('--') + 1:]

    if not args:
        print("error: no blocks provided", file=sys.stderr)
        sys.exit(1)

    # Shared globals dict - state persists across all blocks
    shared_globals = {
        "__name__": "__main__",
        "__builtins__": __builtins__,
    }

    for idx, block in enumerate(args):
        # Emit marker for dispatcher
        print(f"{MARKER}{{{idx}}}{MARKER}")

        # Execute in shared context
        exit_code = 0
        try:
            compiled = compile(block, f"<block {idx + 1}>", "exec")
            exec(compiled, shared_globals)
        except SystemExit as e:
            exit_code = e.code if isinstance(e.code, int) else 1
        except Exception:
            traceback.print_exc()
            exit_code = 1

        if exit_code != 0:
            print(f"{RED}(exit code: {exit_code}){RESET}")

        print()

if __name__ == "__main__":
    main()
