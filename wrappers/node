#!/usr/bin/env node
/**
 * Node.js wrapper for block-run.
 * Executes blocks with vm.runInContext() in a shared context - state persists naturally.
 *
 * This script is invoked BY the target Node interpreter, so it runs in the
 * correct version automatically.
 *
 * Usage: node this-wrapper -- block1 block2 ...
 */

const vm = require('vm');

// ANSI colors
const CYAN = '\x1b[36m';
const RED = '\x1b[31m';
const DIM = '\x1b[2m';
const RESET = '\x1b[0m';

function separator() {
    return DIM + 'â”€'.repeat(41) + RESET;
}

function isCommentOnly(block) {
    // Check if block contains only comments and whitespace
    const lines = block.split('\n');
    for (const line of lines) {
        const stripped = line.trim();
        if (stripped && !stripped.startsWith('//') && !stripped.startsWith('/*') && !stripped.startsWith('*')) {
            return false;
        }
    }
    return true;
}

function highlightJs(code) {
    // Could integrate with a syntax highlighter here
    // For now, just return as-is
    return code;
}

function main() {
    // Parse args - skip everything before '--'
    let args = process.argv.slice(2);
    const dashIndex = args.indexOf('--');
    if (dashIndex !== -1) {
        args = args.slice(dashIndex + 1);
    }

    if (args.length === 0) {
        console.error('error: no blocks provided');
        process.exit(1);
    }

    // Create a persistent context with common globals
    const context = vm.createContext({
        console: console,
        setTimeout: setTimeout,
        setInterval: setInterval,
        clearTimeout: clearTimeout,
        clearInterval: clearInterval,
        setImmediate: setImmediate,
        clearImmediate: clearImmediate,
        Buffer: Buffer,
        process: process,
        require: require,
        __dirname: __dirname,
        __filename: __filename,
        module: module,
        exports: exports,
    });

    args.forEach((block, index) => {
        const blockNum = index + 1;

        // Handle comment-only blocks
        if (isCommentOnly(block)) {
            console.log(`${CYAN}// Block ${blockNum} (comments only)${RESET}`);
            console.log(highlightJs(block));
            console.log(separator());
            console.log();
            return;
        }

        // Show block header and code
        console.log(`${CYAN}// Block ${blockNum}${RESET}`);
        console.log(highlightJs(block));
        console.log(separator());

        // Execute in shared context
        let exitCode = 0;
        try {
            vm.runInContext(block, context, {
                filename: `<block ${blockNum}>`,
                displayErrors: true,
            });
        } catch (err) {
            console.error(err.stack || err);
            exitCode = 1;
        }

        if (exitCode !== 0) {
            console.log(`${RED}(exit code: ${exitCode})${RESET}`);
        }

        console.log();
    });
}

main();
