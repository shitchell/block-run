#!/usr/bin/env node
/**
 * Node.js wrapper for block-run.
 * Minimal: emits markers, executes blocks with vm.runInContext().
 * Dispatcher handles headers, highlighting, separators.
 */

const vm = require('vm');

// Marker character (ASCII Group Separator)
const MARKER = '\x1d';

// Colors for exit code display
const RED = '\x1b[31m';
const RESET = '\x1b[0m';

function main() {
    // Parse args - skip everything before '--'
    let args = process.argv.slice(2);
    const dashIndex = args.indexOf('--');
    if (dashIndex !== -1) {
        args = args.slice(dashIndex + 1);
    }

    if (args.length === 0) {
        console.error('error: no blocks provided');
        process.exit(1);
    }

    // Create a persistent context with common globals
    const context = vm.createContext({
        console: console,
        setTimeout: setTimeout,
        setInterval: setInterval,
        clearTimeout: clearTimeout,
        clearInterval: clearInterval,
        setImmediate: setImmediate,
        clearImmediate: clearImmediate,
        Buffer: Buffer,
        process: process,
        require: require,
        __dirname: __dirname,
        __filename: __filename,
        module: module,
        exports: exports,
    });

    args.forEach((block, idx) => {
        // Emit marker for dispatcher
        console.log(`${MARKER}{${idx}}${MARKER}`);

        // Execute in shared context
        let exitCode = 0;
        try {
            vm.runInContext(block, context, {
                filename: `<block ${idx + 1}>`,
                displayErrors: true,
            });
        } catch (err) {
            console.error(err.stack || err);
            exitCode = 1;
        }

        if (exitCode !== 0) {
            console.log(`${RED}(exit code: ${exitCode})${RESET}`);
        }

        console.log();
    });
}

main();
