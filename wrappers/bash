#!/usr/bin/env bash
set -euo pipefail

# Bash wrapper for block-run
# Minimal: emits markers, executes blocks with eval
# Dispatcher handles headers, highlighting, separators
#
# All variables use __br_ prefix to avoid namespace collisions with user code

# Marker character (ASCII Group Separator)
__br_MARKER=$'\x1d'

# Colors for exit code display
__br_RED=$'\e[31m'
__br_RESET=$'\e[0m'

# Parse arguments - skip everything before '--'
__br_BLOCKS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --)
            shift
            __br_BLOCKS=("$@")
            break
            ;;
        *)
            shift
            ;;
    esac
done

[[ ${#__br_BLOCKS[@]} -gt 0 ]] || { echo "error: no blocks provided" >&2; exit 1; }

__br_idx=0
for __br_block in "${__br_BLOCKS[@]}"; do
    # Emit marker for dispatcher
    echo "${__br_MARKER}{${__br_idx}}${__br_MARKER}"

    # Execute in current shell context
    set +e
    eval "$__br_block"
    __br_exit_code=$?
    set -e

    if [[ $__br_exit_code -ne 0 ]]; then
        echo "${__br_RED}(exit code: $__br_exit_code)${__br_RESET}"
    fi

    echo
    ((__br_idx++))
done
